<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no, maximum-scale=1.0,">
    <script src="https://unpkg.com/@urbit/http-api"></script>
    <script src="/session.js"></script>
    <title>Urbit Counter App</title>
  </head>
  <body>
    <button id="toggle" type="button" onClick="connect()" >Connect</button>

    <pre id="event"></pre>
    <pre id="subNumber"></pre>


    <button id="submit" type="button" onClick="doDownPoke()" >down</button>
    <button id="submit" type="button" onClick="doUpPoke()" >Up</button>
    <p id="err"></p>


  </body>
    <script>
    const toggle = document.getElementById("toggle");
    const event = document.getElementById("event");
    const subNumber = document.getElementById("subNumber");
    subNumber.innerHTML = "no subscription";

    function printEvent(update) {
      event.innerHTML = JSON.stringify(update, null, 2);
    };
    function subFail() {
      event.innerHTML = "Subscription failed!";
    };

    async function connect() {
      console.log('doing connect')
      window.airlock = await UrbitHttpApi.Urbit.authenticate({
          ship: "sum",
          url: "localhost:8080",
          code: "nacmun-tandem-samter-dishes",
          verbose: true
      });
      window.airlock.subscribe({
        app: "counter",
        path: "/web-ui",
        event: printEvent,
        quit: connect,
        err: subFail
      }).then((r) => {
        console.log('subscription id ', r)
        window.id = r
        subNumber.innerHTML = "subscription id " + window.id;
      })
      toggle.innerHTML = "Unsubscribe";
      toggle.onclick = doUnsub;
      event.innerHTML = "Awaiting event";
    };

    function doUnsub() {
      console.log('doing unsub ', window.id)
      window.airlock.unsubscribe(window.id);
      toggle.innerHTML = "Subscribe";
      toggle.onclick = connect;
      subNumber.innerHTML = "no subscription";
      event.innerHTML = "Subscription closed";
    };



    function doUpPoke() {
      window.airlock.poke({
        app: "counter",
        mark: "counter-do",
        json: { inc: null },
        onSuccess: success,
        onError: error
      });
    }

    function doDownPoke() {
      window.airlock.poke({
        app: "counter",
        mark: "counter-do",
        json: { dec: null },
        onSuccess: success,
        onError: error
      });
    }

    function success() {
      // document.getElementById("msg").value = "";
      document.getElementById("err").innerHTML = "";
    }
    function error() {
      // document.getElementById("msg").value = "";
      document.getElementById("err").innerHTML = "Poke failed!";
    }


  </script>

</html>
