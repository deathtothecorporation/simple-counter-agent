<!DOCTYPE html>
<html>

<head>
    <title>Elm Counter App</title>
</head>

<body>
    <div id="elm-node"></div>
    <script src="https://unpkg.com/@urbit/http-api"></script>
    <script src="nock.min.js"></script>
    <script src="main.js"></script>
    <script>
        var app = Elm.Main.init({
            node: document.getElementById('elm-node')
        });

        // function to connect to urbit
        // can also be called by "quit" callback to try to reconnect
        async function connect() {
            console.log('doing connect');
            try {
                window.airlock = await UrbitHttpApi.Urbit.authenticate({
                    ship: "sum",
                    // proxy to localhost:80 to avoid CORS issues
                    url: "http://localhost:5173/api",
                    code: "nacmun-tandem-samter-dishes",
                    verbose: true
                });

                window.id = await window.airlock.subscribe({
                    app: "counter",
                    path: "/web-ui",
                    event: (a => {
                        console.log('got event', a);
                        // cue the event
                        console.log(window.nockjs_.cue(window.nockjs_.Atom.fromInt(a.update['counter'])));
                        // send the update object to elm
                        app.ports.receiveEvent.send(JSON.stringify(a, null, 2));
                    }),
                    quit: connect,
                    err: subFail
                });

                console.log('subscription id ', window.id);
            } catch (e) {
                console.log('error', e);
            }
        }

        // complain if the subscription failed
        // could implement an additional port
        function subFail() {
            console.log('subscription failed');
            app.ports.subscriptionFailed.send("Subscription failed!");
        };

        // subscribe to the "connect" port message
        app.ports.connect.subscribe(async function () {
            await connect();
        });

        // subscribe to the "disconnect" port message
        app.ports.disconnect.subscribe(function () {
            if (!window.airlock) {
                console.log('no airlock');
            } else {
                console.log('doing disconnect');
                window.airlock.unsubscribe(window.id);
                window.airlock = undefined;
            }
        });

        // subscribe to the "sendPoke" port message
        app.ports.sendPoke.subscribe(function (poke) {
            if (!window.airlock) {
                console.log('no airlock');
            } else {
                console.log('sending poke', poke);
                window.airlock.poke({
                    app: "counter",
                    mark: "counter-do",
                    json: JSON.parse(poke), // encode the poke string for consumption by urbit,
                    onSuccess: () => { console.log('poke success'); },
                    onError: (err) => { console.log('poke error', err); }
                });
            }
        });

    </script>
</body>
</html>